<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>City Open World - Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
html, body {
  margin:0;
  padding:0;
  overflow:hidden;
  background:#87ceeb;
  touch-action:none;
}
#joystick {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 120px;
  height: 120px;
  border-radius:50%;
  background: rgba(255,255,255,0.15);
  border: 2px solid rgba(255,255,255,0.4);
}
#stick {
  position: absolute;
  width:40px; height:40px;
  left:40px; top:40px;
  background:white;
  border-radius:50%;
}
#hud {
  position:fixed; top:10px; left:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:8px; border-radius:8px; font-family:Arial;
}
</style>
</head>
<body>

<div id="hud">ğŸ™ï¸ City Stable<br>ğŸ•¹ï¸ Touch Joystick + Camera Rotate</div>
<div id="joystick"><div id="stick"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
/* ===== Scene ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

/* Camera */
const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 3000);

/* Renderer */
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setClearColor(0x87ceeb); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø³ÙÛŒØ¯ ÛŒØ§ Ø³ÛŒØ§Ù‡ Ø´Ø¯Ù†
document.body.appendChild(renderer.domElement);

/* Lights */
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(50,100,50);
scene.add(sun);

/* ===== Ground ===== */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(3000,3000),
  new THREE.MeshStandardMaterial({color:0x555555})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

/* ===== Roads ===== */
function road(x,z,w,h){
  const r = new THREE.Mesh(
    new THREE.PlaneGeometry(w,h),
    new THREE.MeshStandardMaterial({color:0x333333})
  );
  r.rotation.x=-Math.PI/2;
  r.position.set(x,0.01,z);
  scene.add(r);

  // Ø®Ø· ÙˆØ³Ø· Ø³ÙÛŒØ¯
  const line = new THREE.Mesh(
    new THREE.PlaneGeometry(2,h),
    new THREE.MeshStandardMaterial({color:0xffffff})
  );
  line.rotation.x=-Math.PI/2;
  line.position.set(x,0.02,z);
  scene.add(line);

  // Ø®Ø· Ø¹Ø§Ø¨Ø± Ø³ÙÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ
  for(let p=-h/2;p<h/2;p+=40){
    const cross = new THREE.Mesh(
      new THREE.PlaneGeometry(w/10,10),
      new THREE.MeshStandardMaterial({color:0xffffff})
    );
    cross.rotation.x=-Math.PI/2;
    cross.position.set(x,0.03,p);
    scene.add(cross);
  }
}

for(let i=-1200;i<=1200;i+=200){
  road(i,0,40,2400);
  road(0,i,2400,40);
}

/* ===== Buildings with doors & windows ===== */
function building(x,z){
  const h = Math.random()*80+40;
  const colorList = [0xffaa33,0x33ffaa,0xaa33ff,0xff33aa,0x33aaff,0xaaff33];
  const color = colorList[Math.floor(Math.random()*colorList.length)];
  const b = new THREE.Mesh(
    new THREE.BoxGeometry(80,h,80),
    new THREE.MeshStandardMaterial({color:color})
  );
  b.position.set(x,h/2,z);
  scene.add(b);

  // Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§
  const windowGeo = new THREE.PlaneGeometry(10,10);
  for(let y=10;y<h;y+=20){
    const w = new THREE.Mesh(windowGeo,new THREE.MeshStandardMaterial({color:0xffffaa}));
    w.position.set(x+30, y, z+30);
    scene.add(w);
    const w2 = w.clone(); w2.position.set(x-30,y,z+30); scene.add(w2);
    const w3 = w.clone(); w3.position.set(x+30,y,z-30); scene.add(w3);
    const w4 = w.clone(); w4.position.set(x-30,y,z-30); scene.add(w4);
  }

  // Ø¯Ø±
  const doorGeo = new THREE.PlaneGeometry(20,30);
  const door = new THREE.Mesh(doorGeo,new THREE.MeshStandardMaterial({color:0x663300}));
  door.position.set(x,15,z+40);
  scene.add(door);
}

for(let x=-1000;x<=1000;x+=200){
  for(let z=-1000;z<=1000;z+=200){
    if(Math.abs(x)<100||Math.abs(z)<100) continue;
    building(x+60,z+60);
    building(x-60,z-60);
  }
}

/* ===== Clouds ===== */
function cloud(x,y,z){
  const c = new THREE.Mesh(
    new THREE.SphereGeometry(15,16,16),
    new THREE.MeshStandardMaterial({color:0xffffff})
  );
  c.position.set(x,y,z);
  scene.add(c);
  return c;
}
const clouds = [];
for(let i=0;i<50;i++){
  clouds.push(cloud(Math.random()*2000-1000,200+Math.random()*50,Math.random()*2000-1000));
}

/* ===== Player ===== */
const loader = new THREE.TextureLoader();
const player = new THREE.Mesh(
  new THREE.PlaneGeometry(2,3),
  new THREE.MeshStandardMaterial({
    map: loader.load("https://s6.uupload.ir/files/cb5515c6-213f-4693-9189-fec44f12396f_j29.png"),
    transparent:true
  })
);
player.position.y=1.5;
scene.add(player);

/* ===== Camera ===== */
const camOffset = new THREE.Vector3(0,5,-10);
let camAngleX=0, camAngleY=0, draggingCam=false;
let lastX,lastY;
document.addEventListener("touchstart",e=>{
  if(e.touches.length==2){ 
    draggingCam=true;
    lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;
  }
});
document.addEventListener("touchmove",e=>{
  if(draggingCam && e.touches.length==2){
    const dx=e.touches[0].clientX - lastX;
    const dy=e.touches[0].clientY - lastY;
    camAngleX += dx*0.005;
    camAngleY += dy*0.005;
    camAngleY = Math.min(Math.max(camAngleY,-Math.PI/4),Math.PI/4);
    lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;
  }
});
document.addEventListener("touchend",()=>{draggingCam=false;});

/* ===== Joystick ===== */
const joy = document.getElementById("joystick");
const stick = document.getElementById("stick");
let jx=0,jy=0,drag=false;

joy.addEventListener("touchstart",()=>drag=true);
addEventListener("touchend",()=>{
  drag=false;jx=jy=0;
  stick.style.left="40px"; stick.style.top="40px";
});
addEventListener("touchmove",e=>{
  if(!drag) return;
  const r=joy.getBoundingClientRect();
  const t=e.touches[0];
  let x=t.clientX-r.left-60;
  let y=t.clientY-r.top-60;
  const d=Math.min(40,Math.hypot(x,y));
  const a=Math.atan2(y,x);
  jx=Math.cos(a)*(d/40);
  jy=Math.sin(a)*(d/40);
  stick.style.left=40+jx*40+"px";
  stick.style.top=40+jy*40+"px";
});

/* ===== Animate ===== */
function animate(){
  requestAnimationFrame(animate);

  player.position.x += jx*0.25;
  player.position.z += jy*0.25;
  player.lookAt(camera.position);

  let offset = new THREE.Vector3(0,5,-10);
  offset.applyAxisAngle(new THREE.Vector3(0,1,0), camAngleX);
  offset.y += camAngleY*5;
  const camPos = offset.clone().add(player.position);
  camera.position.lerp(camPos,0.1);
  camera.lookAt(player.position);

  clouds.forEach(c=>{c.position.x += 0.2; if(c.position.x>1500)c.position.x=-1500;});

  renderer.render(scene,camera);
}
animate();

/* ===== Resize ===== */
addEventListener("resize",()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>

</body>
  </html>
